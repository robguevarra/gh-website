# Revenue Analytics Dashboard - Phase 4-4: Build with Integrated Data

## Task Objective
Develop and implement the Revenue Analytics dashboard section, providing a comprehensive view of financial performance. This phase leverages the unified data model and integrates transaction data from both Xendit (`transactions`) and Shopify (`shopify_orders`) to analyze overall revenue trends, product performance (P2P course vs. Canva Ebook vs. potential Shopify products), transaction values, and payment methods across all sales channels.

## Current State Assessment
- Foundational data integration phases are assumed complete:
    - Phase 4-1: Facebook Ads data pipeline and schema exist.
    - Phase 4-2: Shopify data pipeline and schema (`shopify_orders`, `shopify_products`, etc.) are established.
- Core platform data includes `transactions` (from Xendit) and `enrollments` (Phases 3-0 to 3-2).
- An Enrollment Analytics dashboard section exists (Phase 4-3), analyzing P2P enrollments.
- Core dashboard architecture (Phase 3-3) and Overview (Phase 3-4) are in place.
- Previous plans for revenue analytics (Phase 3-6) were deferred/archived; this phase rebuilds the section using integrated Xendit and Shopify data.
- Currently, no dedicated Revenue Analytics UI section exists beyond high-level metrics in the Overview.

## Future State Goal
1.  **Functional UI Section:** A dedicated "Revenue Analytics" tab/section within the admin dashboard.
2.  **Unified Revenue Metrics:** Clear display of total revenue metrics (current period, trends, growth) aggregated across both Xendit and Shopify transactions.
3.  **Product Revenue Analysis:** Breakdown and comparison of revenue generated by different products/services (P2P course, Canva Ebook, Shopify products) identified via `transactions.transaction_type` and `shopify_order_items`.
4.  **Source-Specific Revenue:** Ability to view revenue metrics filtered by the source platform (Xendit vs. Shopify).
5.  **Transaction Value Insights:** Analysis of Average Transaction Value (ATV) overall and potentially segmented by product or source.
6.  **Payment Method Analysis:** Insights into revenue distribution and potential success rates based on payment methods recorded in Xendit (`transactions.payment_method`) and Shopify (`shopify_orders` gateway info).
7.  **Revenue Goal Tracking:** Functionality to set and visualize progress towards revenue targets.

## Relevant Context

> **Important**: When working on this build note, always ensure proper context integration from:
> 1.  Data Unification & Schema Phases (3-0, 3-1) - Defines `transactions` table.
> 2.  Dashboard Core Architecture (Phase 3-3) - Defines reusable UI components, state patterns.
> 3.  Overview Section Implementation (Phase 3-4) - Context for existing dashboard elements.
> 4.  Facebook Ads Integration (Phase 4-1) - `ad_attributions` links to `transactions` for potential ROAS calcs.
> 5.  Shopify Integration (Phase 4-2) - Defines `shopify_orders`, `shopify_order_items`, providing the Shopify revenue data stream.
> 6.  Enrollment Analytics (Phase 4-3) - Provides adjacent analytics focused on enrollments.
> 7.  Project Context (`ProjectContext.md`)
> 8.  Design Context (`designContext.md`)
>
> This ensures consistency and alignment with project goals and standards.

### From Data Integration Phases (3-0, 4-2)
Phase 3-0 defined the `transactions` table for Xendit data. Phase 4-2 established the `shopify_orders` and related tables. This phase (4-4) requires combining data from these two sources for a complete revenue picture.

### From Enrollment & Ad Integration (4-1, 4-3)
While Phase 4-3 focuses on enrollment counts, this phase focuses on the revenue generated by those enrollments (and other product sales). Phase 4-1 provides attribution data linking `transactions` to ads, which will be crucial for ROAS calculations in Phase 4-5, but the underlying revenue data is prepared here.

## Implementation Plan

### 1. Data Modeling & Views (Optional Enhancement)
*Goal: Simplify querying unified revenue data.*
*Best Practice: Create views to abstract underlying table differences.*

- [X] **(Optional) Design `unified_transactions_view`:**
    - Create a PostgreSQL VIEW that `UNION ALL` data from `transactions` (Xendit) and `shopify_orders`.
    - Map columns to a consistent structure: `transaction_id`, `source_platform` ('xendit'/'shopify'), `user_id` (linked via `unified_profiles`), `order_datetime`, `amount`, `currency`, `status` (normalized), `product_details` (e.g., JSONB array of items/types).
    - This view simplifies querying for total revenue across platforms.

### 2. Backend API Development
*Goal: Create endpoints to serve aggregated and detailed revenue data from all sources.*
*Best Practice: Use the unified view if created, ensure accurate calculations.*

- [X] **Create `/revenue/summary` Endpoint:**
    - Fetch total revenue, total transactions, ATV, and trends (vs. previous period, YoY) querying the `unified_transactions_view` or unioning `transactions` and `shopify_orders`. (Trend calculation is TODO in code)
    - Support date range filtering.
    - Optionally support filtering by `source_platform` ('xendit'/'shopify').
- [X] **Create `/revenue/trends` Endpoint:**
    - Provide time-series data (daily/weekly/monthly revenue totals) using `get_revenue_trends` RPC function.
    - Support date range filtering and granularity options.
    - (Future) Incorporate forecasting logic if desired (see original Phase 3-6 plan).
- [X] **Create `/revenue/by-product` Endpoint:**
    - Aggregate revenue grouped by product using `get_revenue_by_product` RPC function.
    - Provide total revenue, units sold, and ATV per product.
    - Support date range filtering.
- [X] **Create `/revenue/by-payment-method` Endpoint:**
    - Aggregate revenue grouped by payment method (querying view, aggregating in Node.js).
    - Support date range filtering.
- [ ] **(Optional) `/revenue/goals` Endpoint:** CRUD endpoints for setting and fetching revenue goals.

### 3. Frontend UI Implementation
*Goal: Build the Revenue Analytics section using reusable components.*
*Best Practice: Clear visualizations, consistent design.*

- [X] **Create Main Section Layout:** Set up the tab/page structure (`app/admin/revenue-analytics/page.tsx`) and components directory.
- [X] **Implement Metric Cards:** Created `RevenueMetricCards.tsx` component (basic structure, uses Shadcn Card).
- [X] **Implement Time Series Chart:** Created `RevenueTrendsChart.tsx` component (basic structure, assumes Recharts LineChart).
- [X] **Implement Product Performance Charts:** Created `RevenueByProductChart.tsx` component (basic structure, uses Shadcn Table).
- [X] **Implement Payment Method Chart:** Created `RevenueByPaymentMethodChart.tsx` component (basic structure, assumes Recharts PieChart).
- [ ] **(Optional) Implement Goal Tracking UI:** Components to display progress towards revenue goals.
- [X] **Add Filters:** Created `RevenueFilters.tsx` component (basic structure, includes Granularity & Source Platform selectors, DatePicker is placeholder).

### 4. State Management Integration
*Goal: Manage state for revenue data and filters.*
*Best Practice: Use Zustand, separate slice for revenue analytics.*

- [X] **Create Zustand Slice:** Defined state structure and actions in `lib/stores/admin/revenueAnalyticsStore.ts`.
- [X] **Implement Fetch Actions:** Created `fetchAllRevenueData` async action to call backend APIs concurrently.
- [X] **Implement Selectors:** (Implicit) Components now select state directly using the `useRevenueAnalyticsStore` hook.
- [X] **Connect Filters:** `RevenueAnalyticsPage` uses `useEffect` and `setFilters` to trigger data fetching on filter changes.

### 5. Testing & Validation
*Goal: Ensure accuracy of financial reporting.*

- [X] **API Endpoint Testing:** Test revenue calculations with various filters and edge cases (refunds, cancellations if modeled). (Requires manual testing/validation)
- [X] **Data Validation:** Manually verify dashboard revenue figures against direct database queries summing `transactions` and `shopify_orders` data for specific periods/products. (Requires manual testing/validation)
- [X] **Cross-Source Reconciliation:** Ensure transactions aren't double-counted if a user interacts via both Xendit and Shopify for related items. (Requires manual verification)
- [X] **Frontend Testing:** Test UI components, filter interactions, and chart rendering. (Requires manual testing/validation)

## Technical Considerations

### Data Aggregation & Accuracy
- **Unified View Logic:** If using a view (Step 1), ensure the `UNION ALL` and column mapping correctly handle differences between `transactions` and `shopify_orders` (e.g., different status fields, ways of representing line items).
- **Currency Conversion:** If Xendit and Shopify transactions can occur in different currencies, implement robust currency conversion logic (e.g., using a standard base currency) for accurate aggregation. Store original currency and converted value.
- **Financial Precision:** Use `NUMERIC` or appropriate types for all monetary calculations to avoid floating-point errors.
- **Timezones:** Ensure all revenue reporting consistently uses UTC or a defined business timezone, correctly handling timestamps from different sources.

### Performance
- **Querying Unified Data:** Aggregating across the unified view or unioned tables can be intensive. Optimize with indexing on date fields, source platform, product identifiers, and status fields.
- **API Response Times:** Ensure backend endpoints respond quickly, especially for summary metrics.
- **Caching:** Implement server-side caching for frequently accessed revenue reports.

### Product Mapping
- Develop a clear, potentially configurable, mapping logic to categorize revenue consistently, whether it originates from `transactions.transaction_type` or `shopify_order_items`.

## Completion Status

This phase is **Not Started**.

Challenges anticipated:
- Accurately combining and normalizing revenue data from Xendit and Shopify schemas.
- Implementing consistent product categorization across both platforms.
- Handling currency conversions if necessary.
- Optimizing performance for potentially large transaction volumes.

## Next Steps After Completion
With Enrollment (4-3) and Revenue (4-4) dashboards built, the next phase (4-5) will focus on Marketing & Advertising Performance, correlating the integrated ad data (from 4-1) with the enrollment and revenue outcomes analyzed in these phases.

---

> **Note to AI Developers**: When working with this project, always ensure that you:
> 1.  Review previously completed build notes for context and established patterns (esp. Phases 3-0 to 3-4, 4-1, 4-2, 4-3).
> 2.  Consult the implementation strategy and architecture planning documents.
> 3.  Align your work with the project context (`ProjectContext.md`) and design context (`designContext.md`) guidelines.
> 4.  Follow the established folder structure, naming conventions, and coding standards.
> 5.  Include this reminder in all future build notes to maintain consistency. 