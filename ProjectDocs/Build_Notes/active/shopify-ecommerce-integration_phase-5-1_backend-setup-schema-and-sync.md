# Shopify E-commerce Integration - Phase 5-1: Backend Setup (Schema & Sync)

## Task Objective
Establish the necessary backend database schema modifications and verify/adapt the existing product synchronization mechanism to support the new members-only e-commerce storefront. This involves enhancing the `shopify_products` table to include image data and Google Drive mappings, creating new tables for orders generated via the custom Xendit checkout, and ensuring the Shopify product sync function populates the required product data correctly.

## Current State Assessment
-   Phase 5-0 defined the strategy: Use Shopify as PIM, reuse `shopify_products`, custom Xendit checkout, create new order tables, map products to Google Drive files.
-   Phase 4-2 implemented `shopify_products`, `shopify_customers`, `shopify_orders`, `shopify_order_items` tables *for analytics* and created a `shopify-sync` Edge Function (`supabase/functions/shopify-sync/`) that fetches products via GraphQL and customers/orders via REST.
-   The `shopify-sync` function's GraphQL query for products (`PRODUCTS_QUERY` in `index.ts`) currently **does not fetch image data**.
-   The `upsertProduct` function in `utils.ts` **does not handle or store image data**.
-   The `shopify_products` table **lacks columns** for storing image URLs and Google Drive file/folder IDs.
-   Tables for storing orders generated by the new custom Xendit checkout (`ecommerce_orders`, `ecommerce_order_items`) do not exist.

## Future State Goal
1.  **Enhanced `shopify_products` Table:** The Supabase `shopify_products` table schema includes new columns: `featured_image_url` (TEXT, nullable) and `google_drive_file_id` (TEXT, nullable).
2.  **Adapted Product Sync Function:** The `shopify-sync` Edge Function (`supabase/functions/shopify-sync/`) is updated:
    *   The `PRODUCTS_QUERY` GraphQL query definition in `index.ts` fetches product image URLs (e.g., `featuredImage { url }` or similar).
    *   The `upsertProduct` function in `utils.ts` extracts the image URL from the GraphQL payload and stores it in the new `featured_image_url` column.
3.  **New E-commerce Order Tables:** New tables `ecommerce_orders` and `ecommerce_order_items` are created in Supabase via migrations, ready to store order details from the future custom Xendit checkout flow (Phase 5-3).
4.  **Backend Ready:** The database schema and product sync mechanism are prepared to support the frontend development (Phase 5-2) and checkout implementation (Phase 5-3).

## Relevant Context

> **Important**: When working on this build note, always ensure proper context integration from:
> 1.  Phase 5-0: Strategy & Architecture - Overall plan for this integration.
> 2.  Phase 4-2: Shopify Integration - Details of the *analytics* schema and the existing `shopify-sync` function.
> 3.  Phase 3-1: Database Schema Enhancement - Structure of `unified_profiles` which `ecommerce_orders` will link to.
> 4.  Project Context (`ProjectContext.md`) - Tech stack, goals, PWA structure.
> 5.  Design Context (`designContext.md`) - UI/UX standards (relevant for ensuring necessary product data is available).
> 6.  Build Notes Guidelines (`build-notes-guidelines.md`) - Documentation standards.
>
> This ensures consistency and alignment with project goals and standards.

## Implementation Plan (Phase 5-1)

1.  [ ] **Enhance `shopify_products` Schema:**
    *   [ ] Create a new Supabase migration file (`supabase/migrations/<timestamp>_enhance_shopify_products_for_ecommerce.sql`).
    *   [ ] Add SQL `ALTER TABLE public.shopify_products ADD COLUMN featured_image_url TEXT NULL;` to the migration.
    *   [ ] Add SQL `ALTER TABLE public.shopify_products ADD COLUMN google_drive_file_id TEXT NULL;` to the migration.
    *   [ ] Add SQL `COMMENT ON COLUMN public.shopify_products.featured_image_url IS 'URL for the main product image, synced from Shopify.';`
    *   [ ] Add SQL `COMMENT ON COLUMN public.shopify_products.google_drive_file_id IS 'Google Drive File/Folder ID for the associated digital product asset.';`
    *   [ ] Apply the migration (`supabase db push` or apply via dashboard).
2.  [ ] **Update Shopify Sync GraphQL Query:**
    *   [ ] Edit `supabase/functions/shopify-sync/index.ts`.
    *   [ ] Locate the `PRODUCTS_QUERY` constant.
    *   [ ] Modify the `node` fields within the query to include image data. Choose one appropriate field (consult Shopify GraphQL API docs if needed):
        *   Option A (Featured Image): Add `featuredImage { url }`
        *   Option B (First Image): Add `images(first: 1) { edges { node { url } } }`
    *   *Self-Correction:* Use `featuredImage` as it's simpler and likely sufficient.
3.  [ ] **Update Shopify Sync Upsert Logic:**
    *   [ ] Edit `supabase/functions/shopify-sync/utils.ts`.
    *   [ ] Locate the `upsertProduct` function.
    *   [ ] Modify the `ShopifyProductInsert` type definition (or the inline object) to include `featured_image_url?: string | null;`.
    *   [ ] In the `productData` object assignment, extract the image URL from the GraphQL `payload` (e.g., `payload.featuredImage?.url` or `payload.images?.edges?.[0]?.node?.url`) and assign it to `featured_image_url`. Handle potential null values.
    *   [ ] Ensure the `upsert` call correctly includes the new field.
4.  [ ] **Deploy Updated Sync Function:**
    *   [ ] Deploy the modified `shopify-sync` function to Supabase Edge Functions (`supabase functions deploy shopify-sync --no-verify-jwt`).
5.  [ ] **Test Product Sync:**
    *   [ ] Manually invoke the updated `shopify-sync` function (e.g., via Supabase dashboard or CLI) for a specific product or date range known to have images.
    *   [ ] Verify that the `featured_image_url` column in the `shopify_products` table is populated correctly for the tested products.
6.  [ ] **Create New E-commerce Order Tables Schema:**
    *   [ ] Create a new Supabase migration file (`supabase/migrations/<timestamp>_create_ecommerce_orders.sql`).
    *   [ ] Define `ecommerce_orders` table SQL:
        ```sql
        CREATE TABLE public.ecommerce_orders (
            id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
            user_id UUID NOT NULL REFERENCES auth.users(id),
            unified_profile_id UUID REFERENCES public.unified_profiles(id), -- Denormalized for easier querying
            order_status TEXT NOT NULL DEFAULT 'pending', -- e.g., pending, processing, completed, failed
            total_amount DECIMAL(10, 2) NOT NULL,
            currency VARCHAR(3) NOT NULL,
            payment_method TEXT NOT NULL DEFAULT 'xendit', -- Or other custom methods later
            xendit_payment_id TEXT UNIQUE, -- Link to Xendit payment
            transaction_id UUID REFERENCES public.transactions(id), -- Link to internal transaction record
            created_at TIMESTAMPTZ NOT NULL DEFAULT timezone('utc'::text, now()),
            updated_at TIMESTAMPTZ NOT NULL DEFAULT timezone('utc'::text, now()),

            CONSTRAINT check_order_status CHECK (order_status IN ('pending', 'processing', 'completed', 'failed', 'refunded'))
        );

        ALTER TABLE public.ecommerce_orders ENABLE ROW LEVEL SECURITY;
        -- Add basic RLS policies later as needed

        CREATE INDEX idx_ecommerce_orders_user_id ON public.ecommerce_orders(user_id);
        CREATE INDEX idx_ecommerce_orders_unified_profile_id ON public.ecommerce_orders(unified_profile_id);
        CREATE INDEX idx_ecommerce_orders_transaction_id ON public.ecommerce_orders(transaction_id);
        CREATE INDEX idx_ecommerce_orders_status ON public.ecommerce_orders(order_status);

        COMMENT ON TABLE public.ecommerce_orders IS 'Stores order details generated by the custom Xendit checkout flow.';
        COMMENT ON COLUMN public.ecommerce_orders.xendit_payment_id IS 'Unique identifier from the Xendit payment transaction.';
        COMMENT ON COLUMN public.ecommerce_orders.transaction_id IS 'FK to the unified transactions table.';
        ```
    *   [ ] Define `ecommerce_order_items` table SQL:
        ```sql
        CREATE TABLE public.ecommerce_order_items (
            id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
            order_id UUID NOT NULL REFERENCES public.ecommerce_orders(id) ON DELETE CASCADE,
            product_id UUID NOT NULL REFERENCES public.shopify_products(id), -- Link to the product being purchased
            quantity INT NOT NULL DEFAULT 1,
            price_at_purchase DECIMAL(10, 2) NOT NULL, -- Price when the order was placed
            currency VARCHAR(3) NOT NULL,
            product_snapshot JSONB, -- Optional: Store product details at time of purchase
            created_at TIMESTAMPTZ NOT NULL DEFAULT timezone('utc'::text, now()),

            -- Constraint to ensure a product isn't added multiple times to the same order (adjust if needed)
            UNIQUE (order_id, product_id) 
        );

        ALTER TABLE public.ecommerce_order_items ENABLE ROW LEVEL SECURITY;
        -- Add basic RLS policies later as needed

        CREATE INDEX idx_ecommerce_order_items_order_id ON public.ecommerce_order_items(order_id);
        CREATE INDEX idx_ecommerce_order_items_product_id ON public.ecommerce_order_items(product_id);

        COMMENT ON TABLE public.ecommerce_order_items IS 'Stores individual items associated with a custom e-commerce order.';
        COMMENT ON COLUMN public.ecommerce_order_items.product_id IS 'FK to the shopify_products table.';
        COMMENT ON COLUMN public.ecommerce_order_items.price_at_purchase IS 'Captures the price paid, in case product price changes later.';
        COMMENT ON COLUMN public.ecommerce_order_items.product_snapshot IS 'Optional JSON blob containing product details (title, sku, etc.) at the time of purchase for historical accuracy.';
        ```
    *   [ ] Apply the migration (`supabase db push` or apply via dashboard).
7.  [ ] **(Prep for next phase) Add Product Mapping Task Reminder:**
    *   [ ] Note: The `google_drive_file_id` column in `shopify_products` needs to be populated. This mapping process (manual update, script based on SKU/name, etc.) is outside the scope of *this* build note but is a prerequisite for Phase 5-3 (access granting).

## Completion Status

This phase (5-1) is complete when:
- The `shopify_products` table has the new columns.
- The `shopify-sync` function successfully fetches and stores product images.
- The `ecommerce_orders` and `ecommerce_order_items` tables exist in the database.

## Next Steps After Completion
Proceed with **Phase 5-2: Frontend - Product Display & Cart**, focusing on building the UI components to display products (using the enhanced `shopify_products` table) and implementing the shopping cart within the member dashboard.

---

> **Note to AI Developers**: When working on this project, always ensure that you:
> 1.  Review previously completed build notes for context and established patterns (esp. Phase 3 Data Unification, Phase 4 Analytics Context, Phase 5-0 Strategy).
> 2.  Consult the implementation strategy and architecture planning documents (`ProjectContext.md`, `designContext.md`).
> 3.  Align your work with the project context and design context guidelines.
> 4.  Follow the established folder structure, naming conventions, and coding standards (`build-notes-guidelines.md`).
> 5.  Include this reminder in all future build notes to maintain consistency. 